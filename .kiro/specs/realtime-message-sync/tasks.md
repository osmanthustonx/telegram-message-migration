# Implementation Plan

## Task Summary

本實作計畫將即時訊息同步功能分為 6 個主要任務，共 18 個子任務。任務順序按依賴關係安排，從類型定義開始，到服務實作，最後整合測試。

---

## Tasks

- [ ] 1. 類型定義與錯誤處理基礎建設

- [ ] 1.1 定義即時同步相關資料類型
  - 建立佇列訊息資料結構，包含訊息 ID、時間戳、原始訊息物件與重試計數
  - 定義佇列狀態結構，記錄待處理、已處理與失敗訊息數量
  - 定義佇列處理結果結構，包含成功數、失敗數、跳過數與失敗訊息 ID 列表
  - 建立整體同步統計結構，追蹤活躍監聽器數、接收總數、同步總數、失敗總數、跳過總數
  - _Requirements: 2.4, 6.1, 7.6, 7.7_

- [ ] 1.2 (P) 定義即時同步錯誤類型
  - 建立監聽器初始化失敗錯誤類型，包含對話 ID 與錯誤訊息
  - 建立轉發失敗錯誤類型，包含對話 ID、訊息 ID 與錯誤訊息
  - 建立佇列溢出錯誤類型，包含對話 ID 與丟棄數量
  - 建立 FloodWait 錯誤類型，包含等待秒數
  - 所有錯誤類型需符合專案既有的 discriminated union 模式
  - _Requirements: 1.5, 4.5, 5.1_

- [ ] 1.3 (P) 定義即時同步服務介面
  - 定義啟動監聽方法，接收客戶端與對話 ID，回傳 Result 類型
  - 定義停止監聽方法，接收對話 ID，無回傳值
  - 定義註冊映射方法，接收來源對話 ID 與目標群組 ID
  - 定義處理佇列方法，接收對話 ID 與批次最後訊息 ID，回傳非同步 Result
  - 定義取得佇列狀態方法與取得統計方法
  - 介面需加入現有介面定義檔案，符合專案介面命名慣例
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [ ] 2. 訊息佇列管理功能

- [ ] 2.1 實作對話專屬訊息佇列
  - 建立對話 ID 到訊息陣列的映射結構，支援 O(1) 查詢
  - 實作訊息入列功能，將新訊息依原始 ID 與時間戳加入佇列尾端
  - 入列時需初始化重試計數為零
  - 實作清空指定對話佇列功能，用於資源釋放
  - _Requirements: 2.1, 2.2, 2.6_

- [ ] 2.2 實作佇列上限與溢出處理
  - 設定單一對話佇列上限為 1000 則訊息
  - 當佇列達上限時，丟棄最舊的訊息並記錄警告
  - 產生佇列溢出錯誤事件，包含丟棄數量資訊
  - _Requirements: 5.5_

- [ ] 2.3 實作對話-群組映射管理
  - 建立來源對話 ID 到目標群組 ID 的映射結構，支援 O(1) 查詢
  - 實作註冊映射功能，允許更新已存在的映射
  - 實作查詢目標群組功能，供轉發時使用
  - 實作移除映射功能，用於資源釋放
  - _Requirements: 2.5, 7.4_

- [ ] 3. 事件監聽與訊息捕獲

- [ ] 3.1 實作 Telegram 新訊息事件監聽
  - 建立對話 ID 到事件處理器的映射結構
  - 實作啟動監聽功能，使用 GramJS 的 NewMessage 事件並依對話 ID 過濾
  - 保存事件處理器參照，用於後續移除
  - 啟動成功時更新活躍監聽器計數
  - _Requirements: 1.1, 1.2, 7.2_

- [ ] 3.2 實作訊息事件處理邏輯
  - 收到事件時驗證訊息來源對話是否為監聽中的對話
  - 從事件訊息物件擷取訊息 ID、時間戳與完整訊息
  - 將訊息封裝為佇列訊息格式並入列
  - 更新接收訊息總數統計
  - _Requirements: 1.2, 1.3, 6.1_

- [ ] 3.3 實作停止監聽與資源釋放
  - 實作停止監聽功能，使用保存的處理器參照移除事件監聽
  - 移除監聽器後更新活躍監聽器計數
  - 清空該對話的待處理佇列
  - 移除該對話的映射資料
  - 處理監聽器不存在的邊界情況（靜默忽略）
  - _Requirements: 1.4, 7.3_

- [ ] 3.4 實作監聽初始化錯誤處理
  - 捕捉 GramJS 事件註冊可能發生的例外
  - 將例外轉換為監聽初始化失敗錯誤類型
  - 記錄錯誤日誌並回傳 Result 錯誤結果
  - 確保錯誤不會中斷外部呼叫流程
  - _Requirements: 1.5, 4.3, 4.5_

- [ ] 4. 佇列處理與訊息轉發

- [ ] 4.1 實作佇列處理主流程
  - 實作處理佇列方法，接收對話 ID 與批次最後訊息 ID
  - 取得該對話的待處理佇列並依訊息 ID 升序排序
  - 查詢該對話對應的目標群組 ID
  - 依序處理每則訊息，累計成功、失敗、跳過計數
  - 處理完成後回傳處理結果
  - _Requirements: 2.3, 6.3, 7.5_

- [ ] 4.2 實作訊息去重與順序驗證
  - 處理每則訊息前檢查訊息 ID 是否大於批次最後訊息 ID
  - 若訊息 ID 小於或等於分界點，標記為跳過並記錄為重複
  - 累計跳過計數並更新統計
  - 追蹤每個對話最後處理的訊息 ID
  - _Requirements: 6.2, 6.3, 6.4, 6.5_

- [ ] 4.3 實作單一訊息轉發邏輯
  - 使用 MigrationService 的轉發功能轉發訊息至目標群組
  - 轉發成功後從佇列移除訊息並更新成功計數
  - 更新同步成功總數統計
  - _Requirements: 2.4_

- [ ] 4.4 實作轉發失敗重試機制
  - 轉發失敗時增加該訊息的重試計數
  - 若重試次數未達上限（3 次），將訊息重新加入重試佇列
  - 若重試次數達上限，記錄為失敗並從佇列移除
  - 更新失敗計數與失敗訊息 ID 列表
  - _Requirements: 4.1, 4.2_

- [ ] 4.5 實作 FloodWait 處理
  - 轉發時偵測 FloodWait 錯誤並取得等待秒數
  - 暫停佇列處理指定秒數
  - 等待期間持續允許新訊息入列（不阻塞事件處理）
  - 等待結束後從暫停點繼續處理剩餘訊息
  - 與現有 RateLimiter 服務整合共享狀態
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 5. 與現有遷移流程整合

- [ ] 5.1 擴展 Orchestrator 服務介面
  - 在服務依賴結構中新增即時同步服務為可選依賴
  - 在遷移結果結構中新增即時同步統計欄位
  - 確保向後相容，服務不存在時功能可正常跳過
  - _Requirements: 7.8_

- [ ] 5.2 實作遷移流程中的即時同步呼叫
  - 在對話遷移開始前呼叫啟動監聽，開始累積訊息
  - 在群組建立成功後呼叫註冊映射，建立對話-群組關聯
  - 在批次遷移完成後呼叫處理佇列，傳入最後處理的訊息 ID
  - 在佇列處理完成後呼叫停止監聽，釋放資源
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 5.3 實作 DryRun 模式跳過邏輯
  - 檢查 DryRun 選項，若啟用則跳過所有即時同步操作
  - 不啟動任何事件監聽器
  - 在日誌中記錄已跳過即時同步
  - _Requirements: 3.5_

- [ ] 5.4 實作進度報告整合
  - 在進度報告中包含佇列狀態資訊
  - 顯示待處理訊息數與已處理訊息數
  - 對話遷移完成時輸出該對話的即時同步統計
  - 整體遷移完成時在最終報告中包含即時同步總統計
  - _Requirements: 3.6, 4.4_

- [ ] 6. 測試與驗證

- [ ] 6.1 (P) 建立即時同步服務單元測試
  - 測試啟動監聽功能正確註冊事件處理器
  - 測試訊息入列功能正確維護佇列順序
  - 測試佇列上限與溢出處理行為
  - 測試處理佇列功能的去重邏輯與順序處理
  - 測試佇列狀態與統計計算正確性
  - 測試重試機制與最大重試次數行為
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.3, 2.4, 4.1, 4.2, 5.5, 6.3, 6.4_

- [ ] 6.2 (P) 建立整合測試
  - 測試 Orchestrator 與即時同步服務的完整整合流程
  - 測試批次遷移完成後佇列處理流程
  - 測試 DryRun 模式正確跳過即時同步
  - 測試錯誤路徑下的資源清理確保無洩漏
  - 測試多對話同時遷移的狀態隔離
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 4.3_

- [ ] 6.3 建立 E2E 測試
  - 測試完整遷移流程中即時訊息的捕獲與同步
  - 驗證目標群組訊息順序與來源對話一致
  - 測試 FloodWait 中斷與恢復行為
  - 測試長時間遷移期間的佇列累積與處理
  - _Requirements: 6.6_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 3.1 |
| 1.2 | 3.1, 3.2 |
| 1.3 | 3.2 |
| 1.4 | 3.3 |
| 1.5 | 1.2, 3.4 |
| 2.1 | 2.1 |
| 2.2 | 2.1 |
| 2.3 | 4.1 |
| 2.4 | 1.1, 4.3 |
| 2.5 | 2.3 |
| 2.6 | 2.1 |
| 3.1 | 5.2 |
| 3.2 | 5.2 |
| 3.3 | 5.2 |
| 3.4 | 5.2 |
| 3.5 | 5.3 |
| 3.6 | 5.4 |
| 4.1 | 4.4 |
| 4.2 | 4.4 |
| 4.3 | 3.4 |
| 4.4 | 5.4 |
| 4.5 | 1.2, 3.4 |
| 5.1 | 4.5 |
| 5.2 | 4.5 |
| 5.3 | 4.5 |
| 5.4 | 4.5 |
| 5.5 | 2.2 |
| 6.1 | 1.1, 3.2 |
| 6.2 | 4.2 |
| 6.3 | 4.1, 4.2 |
| 6.4 | 4.2 |
| 6.5 | 4.2 |
| 6.6 | 6.3 |
| 7.1 | 1.3 |
| 7.2 | 1.3, 3.1 |
| 7.3 | 1.3, 3.3 |
| 7.4 | 1.3, 2.3 |
| 7.5 | 1.3, 4.1 |
| 7.6 | 1.1, 1.3 |
| 7.7 | 1.1, 1.3 |
| 7.8 | 5.1 |
