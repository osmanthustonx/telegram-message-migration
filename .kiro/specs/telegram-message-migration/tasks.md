# Implementation Plan

## Task Format Template

> **Parallel marker**: 標記 `(P)` 表示該任務可與同層級其他 `(P)` 任務平行執行。

---

## Tasks

- [x] 1. 專案基礎架構建置
- [x] 1.1 (P) 初始化 TypeScript 專案環境
  - 建立 Node.js 專案並設定 TypeScript 嚴格模式
  - 安裝核心相依套件：telegram (GramJS)、commander、winston、dotenv、input
  - 設定 ESLint 與 Prettier 程式碼風格規範
  - 建立專案目錄結構：src/services、src/types、src/utils
  - _Requirements: 9.2_

- [x] 1.2 (P) 定義共用型別與介面
  - 建立 Result 型別用於統一錯誤處理
  - 定義 DialogType、DialogStatus、LogLevel 等列舉型別
  - 設計服務介面：IAuthService、IDialogService、IGroupService、IMigrationService、IProgressService、ILogService、IConfigLoader
  - 定義資料模型：DialogInfo、GroupInfo、MigrationProgress、AppConfig
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 5.1, 7.1, 8.4_

- [x] 2. 設定管理模組
- [x] 2.1 實作設定載入服務
  - 從環境變數與設定檔讀取 API ID、API Hash 等敏感資訊
  - 驗證必要設定欄位存在且格式正確
  - 提供預設值：批次大小 100、群組名稱前綴 "[Migrated] "、FloodWait 門檻 300 秒
  - 支援對話過濾條件與日期範圍設定
  - _Requirements: 1.1, 1.2, 2.3, 2.4, 2.5_

- [x] 3. 日誌記錄模組
- [x] 3.1 實作多層級日誌服務
  - 整合 winston 日誌框架並設定 Console 與 File 兩個輸出目標
  - 支援 DEBUG、INFO、WARN、ERROR 四個日誌等級
  - 在日誌中遮蔽電話號碼等敏感資訊
  - 實作結構化日誌格式包含時間戳記與上下文資訊
  - _Requirements: 8.4, 8.5, 8.6_

- [x] 3.2 實作 FloodWait 事件追蹤與遷移報告產生
  - 記錄每次 FloodWait 事件的等待秒數與觸發操作
  - 統計 FloodWait 發生次數與總等待時間
  - 產生遷移完成報告包含對話統計、失敗清單、FloodWait 摘要
  - _Requirements: 6.6, 8.3_

- [x] 4. 帳號驗證模組
- [x] 4.1 實作 Telegram 帳號驗證流程
  - 初始化 GramJS TelegramClient 並設定連線參數
  - 實作互動式驗證流程：電話號碼輸入、驗證碼請求、驗證碼驗證
  - 處理驗證碼輸入錯誤並允許重新輸入
  - 支援兩步驟驗證 (2FA) 密碼輸入流程
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7_

- [x] 4.2 實作 Session 管理與自動重連
  - 使用 StringSession 將驗證狀態序列化儲存至檔案
  - 程式啟動時檢查並載入既有 session 以跳過驗證
  - 實作網路中斷時的自動重連機制（最多 3 次）
  - 設定 session 檔案權限為 600 避免敏感資料外洩
  - _Requirements: 1.7, 1.8, 10.1_

- [x] 5. 進度持久化模組
- [x] 5.1 實作進度檔案讀寫
  - 設計 JSON 格式的進度檔案結構包含版本號與時間戳記
  - 實作原子寫入機制：先寫入暫存檔再 rename 避免損毀
  - 載入時驗證 JSON schema 與版本相容性
  - 處理進度檔案不存在時回傳空狀態
  - _Requirements: 5.1, 5.6_

- [x] 5.2 實作對話進度追蹤
  - 為每個對話獨立記錄遷移狀態：pending、in_progress、completed、failed、skipped
  - 成功轉發批次後更新最後處理的訊息 ID 與已遷移訊息數
  - 標記對話完成時記錄完成時間
  - 記錄對話遷移過程中的錯誤詳情
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 5.3 實作進度匯出與匯入
  - 支援將進度狀態匯出為可分享的格式
  - 驗證匯入資料格式並處理無效資料
  - 提供從頭開始或跳過已處理對話的選項
  - _Requirements: 5.2, 5.3, 5.5_

- [x] 6. 對話探索模組
- [x] 6.1 實作對話列舉功能
  - 使用 GramJS getDialogs() 方法取得所有對話清單
  - 自動處理對話數量超過 API 回應上限的分頁情境
  - 辨識對話類型：私人聊天、群組、超級群組、頻道、機器人對話
  - 記錄每個對話的 ID、類型、名稱、訊息總數
  - _Requirements: 2.1, 2.2, 2.7_

- [x] 6.2 實作對話過濾功能
  - 支援依對話 ID 白名單或黑名單過濾
  - 支援依對話類型過濾
  - 支援依日期範圍過濾
  - 支援同時套用多個過濾條件
  - _Requirements: 2.3, 2.4, 2.5, 2.6_

- [x] 7. 群組管理模組
- [x] 7.1 實作目標群組建立
  - 使用 channels.CreateChannel API 建立超級群組 (megagroup)
  - 使用原始對話名稱加上設定的前綴作為新群組名稱
  - 記錄原始對話與新群組的對應關係
  - 處理群組建立失敗並記錄錯誤
  - _Requirements: 3.1, 3.2, 3.7_

- [x] 7.2 實作 B 帳號邀請功能
  - 使用 channels.InviteToChannel API 將 B 帳號加入群組
  - 驗證 B 帳號的使用者名稱或電話號碼是否有效
  - 將 B 帳號設為群組管理員
  - 處理 B 帳號無法被邀請的情境（USER_RESTRICTED、USER_NOT_FOUND）
  - _Requirements: 3.3, 3.4_

- [x] 7.3 實作群組建立錯誤處理
  - 處理達到每日群組建立上限的情境並記錄重試時間
  - 處理同名群組已存在時提供覆寫、跳過或重新命名選項
  - _Requirements: 3.5, 3.6_

- [x] 8. 訊息遷移核心模組
- [x] 8.1 實作訊息歷史取得
  - 使用 messages.GetHistory API 按時間順序分頁取得訊息
  - 支援從指定訊息 ID 繼續取得（斷點續傳）
  - 支援日期範圍過濾
  - 處理訊息包含媒體檔案的情境
  - _Requirements: 4.1, 4.2_

- [x] 8.2 實作訊息批次轉發
  - 使用 messages.ForwardMessages API 批次轉發訊息
  - 使用 Telegram 原生 forward 功能保留訊息來源資訊
  - 每批次最多 100 則訊息，生成唯一 randomId 防止重複
  - 處理單一訊息轉發失敗並記錄後繼續處理
  - _Requirements: 4.3, 4.5, 4.6, 4.7_

- [x] 8.3 實作遷移統計輸出
  - 單一對話遷移完成後輸出該對話的統計資訊
  - 統計已遷移訊息數、失敗訊息數、耗時
  - 更新整體遷移進度統計
  - 顯示目前進度（已轉發數量/總數量、預估剩餘時間）
  - _Requirements: 4.4, 8.1, 8.2_

- [x] 9. 流量控制模組
- [x] 9.1 實作 FloodWait 錯誤處理
  - 捕捉 FloodWaitError 並取得等待秒數
  - 設定 floodSleepThreshold 讓 GramJS 自動處理較短等待
  - 顯示 FloodWait 倒數計時資訊供使用者知悉
  - 等待完成後自動重試操作
  - _Requirements: 6.1, 6.2, 6.5_

- [x] 9.2 實作自適應速率調整
  - 支援使用者設定轉發速率上限
  - 連續發生多次 FloodWait 時自動降低轉發速率
  - 記錄速率調整事件供後續分析
  - 設定合理的批次間隔時間
  - _Requirements: 6.3, 6.4, 6.6_

- [x] 10. 即時訊息同步模組
- [x] 10.1 實作新訊息監聽服務
  - 遷移進行中監聽帳號 A 來源對話的新訊息
  - 使用 GramJS addEventHandler 搭配 NewMessage 事件過濾
  - 將偵測到的新訊息加入對話專屬待轉發佇列
  - _Requirements: 7.1, 7.2_

- [x] 10.2 實作即時訊息佇列處理
  - 當前批次歷史訊息轉發完成後依序處理佇列中的新訊息
  - 確保新訊息與歷史訊息的轉發順序一致
  - 實作去重邏輯確保不重複轉發已遷移訊息
  - 處理即時同步功能發生錯誤時記錄並繼續歷史訊息遷移
  - _Requirements: 7.3, 7.4, 7.5_

- [x] 11. 命令列介面模組
- [x] 11.1 實作主程式進入點與命令解析
  - 使用 commander 定義 CLI 命令：migrate、status、export、import、clean
  - 支援設定檔路徑、進度檔路徑、詳細輸出等選項
  - 支援 --dry-run 預覽模式與 --dialog 指定對話遷移
  - 驗證啟動前必要設定存在
  - _Requirements: 9.3, 8.1_

- [x] 11.2 實作即時進度顯示
  - 顯示當前處理的對話名稱與類型
  - 顯示已處理訊息數與訊息總數
  - 計算並顯示預估剩餘時間 (ETA)
  - 在 FloodWait 時顯示倒數計時
  - _Requirements: 8.1, 8.2_

- [x] 11.3 實作安全中斷機制
  - 註冊 SIGINT (Ctrl+C) 訊號處理
  - 收到中斷訊號時安全地儲存當前進度
  - 完成當前批次後再結束程式
  - 顯示進度已儲存的確認訊息
  - _Requirements: 5.2, 5.6_

- [x] 12. Mac 可執行檔打包
- [x] 12.1 (P) 設定建置環境與腳本
  - 使用 esbuild 將 TypeScript 編譯並打包為單一 JavaScript 檔案
  - 建立 sea-config.json 設定 Node.js SEA blob 產生
  - 撰寫建置腳本支援 Intel (x64) 與 Apple Silicon (arm64) 架構
  - _Requirements: 9.1, 9.2, 9.5_

- [x] 12.2 (P) 實作執行檔產生流程
  - 使用 postject 將 SEA blob 注入 Node.js binary
  - 處理 macOS 程式碼簽署：移除原簽署後重新 ad-hoc 簽署
  - 驗證執行檔可正常啟動命令列介面或互動式終端
  - _Requirements: 9.3, 9.4_

- [x] 12.3 驗證執行檔相容性
  - 測試在 macOS 12 (Monterey) 及更新版本上執行
  - 測試 Intel 與 Apple Silicon 兩種架構執行結果一致
  - 處理執行環境缺少必要權限時顯示明確的權限要求說明
  - _Requirements: 9.4, 9.5, 9.6_

- [x] 13. 安全性與資料保護
- [x] 13.1 (P) 實作本機資料安全
  - 確保所有 session 與進度資料僅儲存於本機，不傳輸至任何遠端伺服器
  - 驗證使用 Telegram 官方 MTProto 協定進行所有 API 通訊
  - _Requirements: 10.1, 10.2_

- [x] 13.2 (P) 實作資料清除功能
  - 實作 clean 命令安全刪除所有本機儲存的 session 與進度資料
  - 清除時先覆寫檔案內容再刪除，避免資料殘留
  - _Requirements: 10.3_

- [x] 13.3 實作安全性驗證
  - 確保不儲存使用者輸入的密碼或 2FA 驗證碼
  - 實作 session 檔案完整性驗證，偵測到可能被竄改時拒絕使用並提示重新登入
  - _Requirements: 10.4, 10.5_

- [x] 14. 整合測試與驗證
- [x] 14.1 實作服務整合與主流程協調
  - 連接所有服務模組形成完整遷移流程
  - 驗證流程：驗證 → 對話列舉 → 群組建立 → 訊息遷移 → 即時同步 → 報告
  - 確保服務間資料傳遞正確
  - 處理跨服務錯誤傳播與中止條件
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 5.1, 7.1, 8.1_

- [x] 14.2 實作錯誤恢復流程
  - 驗證斷點續傳：中斷後能從上次進度繼續
  - 驗證網路錯誤恢復：自動重連後繼續作業
  - 驗證 FloodWait 處理：等待後正確重試
  - 驗證單一訊息失敗不影響整體流程
  - _Requirements: 1.7, 5.2, 6.1, 4.7_

- [x] 14.3 驗收測試覆蓋
  - 驗證所有驗收條件：1.1-1.8 帳號驗證流程完整
  - 驗證所有驗收條件：2.1-2.7 對話探索與過濾正確
  - 驗證所有驗收條件：3.1-3.7 群組建立與邀請成功
  - 驗證所有驗收條件：4.1-4.7 訊息遷移完整保留原始資訊
  - 驗證所有驗收條件：5.1-5.6 斷點續傳機制可靠
  - 驗證所有驗收條件：6.1-6.6 流量控制有效避免封鎖
  - 驗證所有驗收條件：7.1-7.5 即時同步不遺漏新訊息
  - 驗證所有驗收條件：8.1-8.6 進度報告與日誌完整
  - 驗證所有驗收條件：9.1-9.6 Mac 可執行檔正常運作
  - 驗證所有驗收條件：10.1-10.5 安全性與資料保護措施到位
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 7.1, 7.2, 7.3, 7.4, 7.5, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 10.1, 10.2, 10.3, 10.4, 10.5_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 1.2, 2.1, 4.1, 14.1, 14.3 |
| 1.2 | 2.1, 4.1, 14.3 |
| 1.3 | 4.1, 14.3 |
| 1.4 | 4.1, 14.3 |
| 1.5 | 4.1, 14.3 |
| 1.6 | 4.1, 14.3 |
| 1.7 | 4.1, 4.2, 14.2, 14.3 |
| 1.8 | 4.2, 14.3 |
| 2.1 | 1.2, 6.1, 14.1, 14.3 |
| 2.2 | 6.1, 14.3 |
| 2.3 | 2.1, 6.2, 14.3 |
| 2.4 | 2.1, 6.2, 14.3 |
| 2.5 | 2.1, 6.2, 14.3 |
| 2.6 | 6.2, 14.3 |
| 2.7 | 6.1, 14.3 |
| 3.1 | 1.2, 7.1, 14.1, 14.3 |
| 3.2 | 7.1, 14.3 |
| 3.3 | 7.2, 14.3 |
| 3.4 | 7.2, 14.3 |
| 3.5 | 7.3, 14.3 |
| 3.6 | 7.3, 14.3 |
| 3.7 | 7.1, 14.3 |
| 4.1 | 1.2, 8.1, 14.1, 14.3 |
| 4.2 | 8.1, 14.3 |
| 4.3 | 8.2, 14.3 |
| 4.4 | 8.3, 14.3 |
| 4.5 | 8.2, 14.3 |
| 4.6 | 8.2, 14.3 |
| 4.7 | 8.2, 14.2, 14.3 |
| 5.1 | 1.2, 5.1, 5.2, 14.1, 14.3 |
| 5.2 | 5.2, 5.3, 11.3, 14.2, 14.3 |
| 5.3 | 5.2, 5.3, 14.3 |
| 5.4 | 5.2, 14.3 |
| 5.5 | 5.2, 5.3, 14.3 |
| 5.6 | 5.1, 11.3, 14.3 |
| 6.1 | 9.1, 14.2, 14.3 |
| 6.2 | 9.1, 14.3 |
| 6.3 | 9.2, 14.3 |
| 6.4 | 9.2, 14.3 |
| 6.5 | 9.1, 14.3 |
| 6.6 | 3.2, 9.2, 14.3 |
| 7.1 | 1.2, 10.1, 14.1, 14.3 |
| 7.2 | 10.1, 14.3 |
| 7.3 | 10.2, 14.3 |
| 7.4 | 10.2, 14.3 |
| 7.5 | 10.2, 14.3 |
| 8.1 | 8.3, 11.1, 11.2, 14.1, 14.3 |
| 8.2 | 8.3, 11.2, 14.3 |
| 8.3 | 3.2, 14.3 |
| 8.4 | 1.2, 3.1, 14.3 |
| 8.5 | 3.1, 14.3 |
| 8.6 | 3.1, 14.3 |
| 9.1 | 12.1, 14.3 |
| 9.2 | 1.1, 12.1, 14.3 |
| 9.3 | 11.1, 12.2, 14.3 |
| 9.4 | 12.2, 12.3, 14.3 |
| 9.5 | 12.1, 12.3, 14.3 |
| 9.6 | 12.3, 14.3 |
| 10.1 | 4.2, 13.1, 14.3 |
| 10.2 | 13.1, 14.3 |
| 10.3 | 13.2, 14.3 |
| 10.4 | 13.3, 14.3 |
| 10.5 | 13.3, 14.3 |

---

## Parallel Execution Analysis

以下任務組可平行執行：

**Phase 1 - 專案基礎架構（可平行）**:
- Task 1.1: 專案環境初始化
- Task 1.2: 型別與介面定義

**Phase 2 - 獨立服務模組（需依賴 Phase 1 完成）**:
- Task 2.1: 設定管理
- Task 3.1, 3.2: 日誌記錄（依賴 2.1）
- Task 4.1, 4.2: 帳號驗證（依賴 3.1）
- Task 5.1, 5.2, 5.3: 進度持久化（相互依賴）
- Task 6.1, 6.2: 對話探索（相互依賴）
- Task 7.1, 7.2, 7.3: 群組管理（相互依賴）

**Phase 3 - 核心功能（需依賴 Phase 2）**:
- Task 8.1, 8.2, 8.3: 訊息遷移（相互依賴）
- Task 9.1, 9.2: 流量控制（相互依賴）
- Task 10.1, 10.2: 即時訊息同步（相互依賴）
- Task 11.1, 11.2, 11.3: CLI（相互依賴）

**Phase 4 - 打包與安全（可平行，需依賴 Phase 3）**:
- Task 12.1, 12.2: Mac 打包（可平行，12.3 依賴前兩者）
- Task 13.1, 13.2: 安全性（可平行，13.3 依賴驗證模組）

**Phase 5 - 整合（需依賴所有前置）**:
- Task 14.1 → Task 14.2 → Task 14.3 (依賴鏈)
