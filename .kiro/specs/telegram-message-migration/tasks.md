# Implementation Plan

## Task Format Template

> **Parallel marker**: 標記 `(P)` 表示該任務可與同層級其他 `(P)` 任務平行執行。

---

## Tasks

- [ ] 1. 專案基礎架構建置
- [x] 1.1 (P) 初始化 TypeScript 專案環境
  - 建立 Node.js 專案並設定 TypeScript 嚴格模式
  - 安裝核心相依套件：telegram (GramJS)、commander、winston、dotenv、input
  - 設定 ESLint 與 Prettier 程式碼風格規範
  - 建立專案目錄結構：src/services、src/types、src/utils
  - _Requirements: 8.1, 8.2_

- [x] 1.2 (P) 定義共用型別與介面
  - 建立 Result 型別用於統一錯誤處理
  - 定義 DialogType、DialogStatus、LogLevel 等列舉型別
  - 設計服務介面：IAuthService、IDialogService、IGroupService、IMigrationService、IProgressService、ILogService、IConfigLoader
  - 定義資料模型：DialogInfo、GroupInfo、MigrationProgress、AppConfig
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 6.1, 7.1, 8.2_

- [ ] 2. 設定管理模組
- [ ] 2.1 實作設定載入服務
  - 從環境變數與設定檔讀取 API ID、API Hash 等敏感資訊
  - 驗證必要設定欄位存在且格式正確
  - 提供預設值：批次大小 100、群組名稱前綴 "[Migrated] "、FloodWait 門檻 300 秒
  - 支援對話過濾條件與日期範圍設定
  - _Requirements: 8.2, 8.4, 8.5_

- [ ] 3. 日誌記錄模組
- [ ] 3.1 實作多層級日誌服務
  - 整合 winston 日誌框架並設定 Console 與 File 兩個輸出目標
  - 支援 DEBUG、INFO、WARN、ERROR 四個日誌等級
  - 在日誌中遮蔽電話號碼等敏感資訊
  - 實作結構化日誌格式包含時間戳記與上下文資訊
  - _Requirements: 7.1, 7.2, 7.5, 7.6_

- [ ] 3.2 實作 FloodWait 事件追蹤與遷移報告產生
  - 記錄每次 FloodWait 事件的等待秒數與觸發操作
  - 統計 FloodWait 發生次數與總等待時間
  - 產生遷移完成報告包含對話統計、失敗清單、FloodWait 摘要
  - _Requirements: 5.6, 7.4_

- [ ] 4. 帳號驗證模組
- [ ] 4.1 實作 Telegram 帳號驗證流程
  - 初始化 GramJS TelegramClient 並設定連線參數
  - 實作互動式驗證流程：電話號碼輸入、驗證碼請求、驗證碼驗證
  - 處理驗證碼輸入錯誤並允許重新輸入
  - 支援兩步驟驗證 (2FA) 密碼輸入流程
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 4.2 實作 Session 管理與自動重連
  - 使用 StringSession 將驗證狀態序列化儲存至檔案
  - 程式啟動時檢查並載入既有 session 以跳過驗證
  - 實作網路中斷時的自動重連機制（最多 3 次）
  - 設定 session 檔案權限為 600 避免敏感資料外洩
  - _Requirements: 1.5, 1.6_

- [ ] 5. 進度持久化模組
- [ ] 5.1 實作進度檔案讀寫
  - 設計 JSON 格式的進度檔案結構包含版本號與時間戳記
  - 實作原子寫入機制：先寫入暫存檔再 rename 避免損毀
  - 載入時驗證 JSON schema 與版本相容性
  - 處理進度檔案不存在時回傳空狀態
  - _Requirements: 6.1, 6.3, 6.6_

- [ ] 5.2 實作對話進度追蹤
  - 為每個對話獨立記錄遷移狀態：pending、in_progress、completed、failed、skipped
  - 成功轉發批次後更新最後處理的訊息 ID 與已遷移訊息數
  - 標記對話完成時記錄完成時間
  - 記錄對話遷移過程中的錯誤詳情
  - _Requirements: 6.2, 6.4, 6.5_

- [ ] 5.3 實作進度匯出與匯入
  - 支援將進度狀態匯出為可分享的格式
  - 驗證匯入資料格式並處理無效資料
  - 提供從頭開始或跳過已處理對話的選項
  - _Requirements: 6.6, 6.7_

- [ ] 6. 對話探索模組
- [ ] 6.1 實作對話列舉功能
  - 使用 GramJS getDialogs() 方法取得所有對話清單
  - 自動處理對話數量超過 API 回應上限的分頁情境
  - 辨識對話類型：私人聊天、群組、超級群組、頻道、機器人對話
  - 記錄每個對話的 ID、類型、名稱、訊息總數
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 6.2 實作對話過濾功能
  - 支援依對話 ID 白名單或黑名單過濾
  - 支援依對話類型過濾
  - 對話列舉完成後自動開始遷移流程
  - _Requirements: 2.5, 8.4_

- [ ] 7. 群組管理模組
- [ ] 7.1 實作目標群組建立
  - 使用 channels.CreateChannel API 建立超級群組 (megagroup)
  - 使用原始對話名稱加上設定的前綴作為新群組名稱
  - 記錄原始對話與新群組的對應關係
  - 處理群組建立失敗並記錄錯誤
  - _Requirements: 3.1, 3.2, 3.5, 3.6_

- [ ] 7.2 實作 B 帳號邀請功能
  - 使用 channels.InviteToChannel API 將 B 帳號加入群組
  - 驗證 B 帳號的使用者名稱或電話號碼是否有效
  - 處理 B 帳號無法被邀請的情境（USER_RESTRICTED、USER_NOT_FOUND）
  - 若邀請失敗則中止該對話遷移並記錄錯誤
  - _Requirements: 3.3, 3.4_

- [ ] 8. 訊息遷移核心模組
- [ ] 8.1 實作訊息歷史取得
  - 使用 messages.GetHistory API 按時間順序分頁取得訊息
  - 支援從指定訊息 ID 繼續取得（斷點續傳）
  - 支援日期範圍過濾
  - 處理訊息包含媒體檔案的情境
  - _Requirements: 4.1, 4.2, 8.5_

- [ ] 8.2 實作訊息批次轉發
  - 使用 messages.ForwardMessages API 批次轉發訊息
  - 每批次最多 100 則訊息，生成唯一 randomId 防止重複
  - 確保媒體內容完整轉發並保留原始發送者資訊
  - 處理單一訊息轉發失敗並記錄後繼續處理
  - _Requirements: 4.3, 4.4, 4.5, 4.6, 7.3_

- [ ] 8.3 實作遷移統計輸出
  - 單一對話遷移完成後輸出該對話的統計資訊
  - 統計已遷移訊息數、失敗訊息數、耗時
  - 更新整體遷移進度統計
  - _Requirements: 4.7_

- [ ] 9. 流量控制模組
- [ ] 9.1 實作 FloodWait 錯誤處理
  - 捕捉 FloodWaitError 並取得等待秒數
  - 設定 floodSleepThreshold 讓 GramJS 自動處理較短等待
  - 顯示 FloodWait 倒數計時資訊供使用者知悉
  - 等待完成後自動重試操作
  - _Requirements: 5.2, 5.3_

- [ ] 9.2 實作自適應速率調整
  - 支援使用者設定轉發速率上限
  - 連續發生多次 FloodWait 時自動降低轉發速率
  - 記錄速率調整事件供後續分析
  - 設定合理的批次間隔時間
  - _Requirements: 5.1, 5.4, 5.5_

- [ ] 10. 命令列介面模組
- [ ] 10.1 實作主程式進入點與命令解析
  - 使用 commander 定義 CLI 命令：migrate、status、export、import
  - 支援設定檔路徑、進度檔路徑、詳細輸出等選項
  - 支援 --dry-run 預覽模式與 --dialog 指定對話遷移
  - 驗證啟動前必要設定存在
  - _Requirements: 8.1, 8.2, 8.4_

- [ ] 10.2 實作即時進度顯示
  - 顯示當前處理的對話名稱與類型
  - 顯示已處理訊息數與訊息總數
  - 計算並顯示預估剩餘時間 (ETA)
  - 在 FloodWait 時顯示倒數計時
  - _Requirements: 8.3_

- [ ] 10.3 實作安全中斷機制
  - 註冊 SIGINT (Ctrl+C) 訊號處理
  - 收到中斷訊號時安全地儲存當前進度
  - 完成當前批次後再結束程式
  - 顯示進度已儲存的確認訊息
  - _Requirements: 8.6_

- [ ] 11. 整合測試與驗證
- [ ] 11.1 實作服務整合與主流程協調
  - 連接所有服務模組形成完整遷移流程
  - 驗證流程：驗證 → 對話列舉 → 群組建立 → 訊息遷移 → 報告
  - 確保服務間資料傳遞正確
  - 處理跨服務錯誤傳播與中止條件
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 6.1, 7.1, 8.1_

- [ ] 11.2 實作錯誤恢復流程
  - 驗證斷點續傳：中斷後能從上次進度繼續
  - 驗證網路錯誤恢復：自動重連後繼續作業
  - 驗證 FloodWait 處理：等待後正確重試
  - 驗證單一訊息失敗不影響整體流程
  - _Requirements: 1.6, 5.2, 6.3, 7.3_

- [ ]*  11.3 驗收測試覆蓋
  - 驗證所有驗收條件：1.1-1.6 帳號驗證流程完整
  - 驗證所有驗收條件：2.1-2.5 對話探索與過濾正確
  - 驗證所有驗收條件：3.1-3.6 群組建立與邀請成功
  - 驗證所有驗收條件：4.1-4.7 訊息遷移完整保留原始資訊
  - 驗證所有驗收條件：5.1-5.6 流量控制有效避免封鎖
  - 驗證所有驗收條件：6.1-6.7 斷點續傳機制可靠
  - 驗證所有驗收條件：7.1-7.6 錯誤處理與日誌完整
  - 驗證所有驗收條件：8.1-8.6 CLI 操作流暢
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 1.2, 4.1, 11.1, 11.3 |
| 1.2 | 4.1, 11.3 |
| 1.3 | 4.1, 11.3 |
| 1.4 | 4.1, 11.3 |
| 1.5 | 4.2, 11.3 |
| 1.6 | 4.2, 11.2, 11.3 |
| 2.1 | 1.2, 6.1, 11.1, 11.3 |
| 2.2 | 6.1, 11.3 |
| 2.3 | 6.1, 11.3 |
| 2.4 | 6.1, 11.3 |
| 2.5 | 6.2, 11.3 |
| 3.1 | 1.2, 7.1, 11.1, 11.3 |
| 3.2 | 7.1, 11.3 |
| 3.3 | 7.2, 11.3 |
| 3.4 | 7.2, 11.3 |
| 3.5 | 7.1, 11.3 |
| 3.6 | 7.1, 11.3 |
| 4.1 | 1.2, 8.1, 11.1, 11.3 |
| 4.2 | 8.1, 11.3 |
| 4.3 | 8.2, 11.3 |
| 4.4 | 8.2, 11.3 |
| 4.5 | 8.2, 11.3 |
| 4.6 | 8.2, 11.3 |
| 4.7 | 8.3, 11.3 |
| 5.1 | 9.2, 11.3 |
| 5.2 | 9.1, 11.2, 11.3 |
| 5.3 | 9.1, 11.3 |
| 5.4 | 9.2, 11.3 |
| 5.5 | 9.2, 11.3 |
| 5.6 | 3.2, 11.3 |
| 6.1 | 1.2, 5.1, 11.1, 11.3 |
| 6.2 | 5.2, 11.3 |
| 6.3 | 5.1, 11.2, 11.3 |
| 6.4 | 5.2, 11.3 |
| 6.5 | 5.2, 11.3 |
| 6.6 | 5.1, 5.3, 11.3 |
| 6.7 | 5.3, 11.3 |
| 7.1 | 1.2, 3.1, 11.1, 11.3 |
| 7.2 | 3.1, 11.3 |
| 7.3 | 8.2, 11.2, 11.3 |
| 7.4 | 3.2, 11.3 |
| 7.5 | 3.1, 11.3 |
| 7.6 | 3.1, 11.3 |
| 8.1 | 1.1, 1.2, 10.1, 11.1, 11.3 |
| 8.2 | 1.1, 1.2, 2.1, 10.1, 11.3 |
| 8.3 | 10.2, 11.3 |
| 8.4 | 6.2, 10.1, 11.3 |
| 8.5 | 2.1, 8.1, 11.3 |
| 8.6 | 10.3, 11.3 |

---

## Parallel Execution Analysis

以下任務組可平行執行：

**Phase 1 - 專案基礎架構（可平行）**:
- Task 1.1: 專案環境初始化
- Task 1.2: 型別與介面定義

**Phase 2 - 獨立服務模組（需依賴 Phase 1 完成）**:
- Task 2.1 → Task 3.1 → Task 4.1 (依賴鏈: 設定 → 日誌 → 驗證)
- Task 5.1, 5.2, 5.3: 進度持久化（相互依賴）
- Task 6.1, 6.2: 對話探索（相互依賴）
- Task 7.1, 7.2: 群組管理（相互依賴）

**Phase 3 - 核心功能（需依賴 Phase 2）**:
- Task 8.1, 8.2, 8.3: 訊息遷移（相互依賴）
- Task 9.1, 9.2: 流量控制（相互依賴）
- Task 10.1, 10.2, 10.3: CLI（相互依賴）

**Phase 4 - 整合（需依賴所有前置）**:
- Task 11.1 → Task 11.2 → Task 11.3 (依賴鏈)
